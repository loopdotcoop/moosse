<!DOCTYPE HTML>
<html lang="en-GB">
<head>




<!-- META -->

<!-- Technical meta -->
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport"
   content="width=device-width, initial-scale=1.0, shrink-to-fit=no,
            maximum-scale=1.0, user-scalable=no">

<!-- Search engine meta -->
<title>Oompsh 0.0.7</title><!-- OOMBUMPABLE -->
<meta name="description"
   content="A Node.js server which adds realtime push notification to Oom apps">
<link rel="author" href="README.md">




<!-- SCRIPT AND STYLE -->

<style>
h2, nav {
    display: inline-block;
    margin: 0;
}
p {
    margin: 0;
}
input, pre, button {
    width: 100%;
    padding: 0.5em 1em;
    box-sizing: border-box;
    border-radius: 0.5em;
    border: none;
    background: #ddd;
    font: 1em/0.65 monospace;
}
input {
    width: 50%;
    background: #cde;
    border-top: 2px solid #abc;
    border-bottom: 2px solid #def;
}
input.valid {
    background: #ced;
    border-top: 2px solid #acb;
    border-bottom: 2px solid #dfe;
}
input.invalid {
    background: #ecd;
    border-top: 2px solid #cab;
    border-bottom: 2px solid #fde;
}
button {
    background: #ccc;
    border-top: 2px solid #eee;
    border-bottom: 2px solid #bbb;
    cursor: pointer;
    transition: background-color 0.2s;
}
button:hover {
    background: #ddd;
}
button:focus {
    background: #bbb;
}
button::-moz-focus-inner {
    border: 0; /* Firefox */
}
input#admin-user, input#admin-pass,
input#enduser-user, input#enduser-pass,
button {
    width: 20%;
}
pre {
    line-height: 2px;
}
pre div {
    padding: 0.2em;
    margin:0;
    line-height: 1em;
}
pre .client  { background: #eee }
pre .server  { background: #cde }
pre .client.error { color: red }
pre .client.ok    { color: black }
pre .server.error { color: red }
pre .server.ok    { color: #16a }
.hid {
    display: none;
}
</style>





</head>
<body>
<div class="container">




<!-- Header and Navigation menu -->
<h2>Oompsh 0.0.7</h2><!-- OOMBUMPABLE -->
<nav> &nbsp;
  <a href="index.html" id="home-link">Home</a> &nbsp;
  <a href="support/test.html">Test @TODO</a> &nbsp;
  <a href="https://github.com/loopdotcoop/oompsh">Repo</a> &nbsp;
  <a href="https://www.npmjs.com/package/oompsh">NPM</a> &nbsp;&nbsp;
</nav>

<p>A Node.js server which adds realtime push notification to Oom apps</p>




<!-- Oompsh utilities, used by the Admin Client and Enduser Client -->
<script>!function(){

//// Global API.
window.OOMPSH = {
    logClient: function (data) { log(this, data, 'client') }
  , logServer: function (data) { log(this, data, 'server') }
  , post // defined below
  , connect // defined below
  , disconnect // defined below
}


//// Updates the log.
function log ($log, data, source) {
    const label = data.error ? 'error' : 'ok'
    const msg   = data.error || data.ok || JSON.stringify(data)
    $log.lines.unshift('<div class="' + label + ' ' + source + '">'
      + ('    ' + ++$log.lineTally).slice(-4) + ' ' + msg.trim()
      + '</div>' )
    $log.lines = $log.lines.slice(0,10)
    $log.innerHTML = ''
      // + 'Tries since modification: ' + triesSinceModification + '<br><br>\n'
      // + (null == numResults ? '' : 'Try ' + getTypes() + ' at ' + tryInfo() + '<br><br><br>\n')
      + $log.lines.join('\n')
}//log


//// POSTs to a URL and logs the result.
function post (config) {

    //// Use the `config` object to retrieve variables.
    const { $domain, $action, $msg, $user, $pass, logClient, logServer } = config
    let domain = ( $domain.value || $domain.getAttribute('placeholder') ).trim()
      , action = ( $action.value || $action.getAttribute('placeholder') ).trim()
      , msg    = (    $msg.value ||    $msg.getAttribute('placeholder') ).trim()
      , user   = (   $user.value ||   $user.getAttribute('placeholder') ).trim()
      , pass   = (   $pass.value ||   $pass.getAttribute('placeholder') ).trim()
    domain += /\/$/.test(domain) ? '' : '/' // append a slash, if missing

    //// Build the URL, eg 'http://localhost:1234/jo:pw/notify', and POST body.
    const url = domain + user + ':' + pass + '/' + action
    const paranoidUrl = domain + user + ':•••/' + action
    const body = JSON.stringify({ msg }) // eg '{ "msg":"Here is my message" }'

    //// Log that `post()` has been called. @TODO log invalidation errors too
    logClient({ ok:`post() will POST ${body} to ${paranoidUrl}` })

    //// Use the (newish) Fetch API to make the POST request.
    fetch(
        url
      , {   body                       // must match 'Content-Type' header
          , method:      'POST'        // *GET, POST, PUT, DELETE, etc.
          , cache:       'no-cache'    // *default, no-cache, reload, force-c...
          , mode:        'cors'        // *same-origin, no-cors, cors
          , redirect:    'error'       // *manual, follow, error
          , referrer:    'no-referrer' // *client, no-referrer
          , credentials: 'omit'        // *omit, include, same-origin
          , headers: {
                'Content-Type':'application/json'
            }
        }
    ).then(res => res.json()) // parse response to JSON
     .then( data => logServer(data) )
     .catch(data => logServer(data) )

}//post()


//// Makes an SSE (Server-Sent Events) connection.
function connect (config) {

    //// Use the `config` object to retrieve variables.
    const { $domain, $user, $pass, $connect, $disconnect, logClient, logServer, usertype } = config
    let domain = ( $domain.value || $domain.getAttribute('placeholder') ).trim()
      , user   = (   $user.value ||   $user.getAttribute('placeholder') ).trim()
      , pass   = (   $pass.value ||   $pass.getAttribute('placeholder') ).trim()
    domain += /\/$/.test(domain) ? '' : '/' // append a slash, if missing

    //// Build the URL, eg 'http://localhost:1234/jo:pw/connect/enduser'
    const url = domain + user + ':' + pass + '/connect/' + usertype
    const paranoidUrl = domain + user + ':•••/connect/' + usertype

    //// Log that `connect()` has been called.
    if ('admin' !== usertype && 'enduser' !== usertype)
        return logClient({ error:'Can’t connect: `usertype` invalid' })
    if (config.es)
        return logClient({ error:'Can’t connect: EventSource already connected' })
    if (! window.EventSource)
        return logClient({ error:'Can’t connect: EventSource not supported' })
    logClient({ ok:`connect() will connect to ${paranoidUrl}` })

    //// Update the buttons.
    $connect.className = 'hid'
    $disconnect.className = ''

    const es = config.es = new EventSource(url)
    es.addEventListener('message', evt => {
        let data
        try { data = JSON.parse(evt.data)
        } catch (err) {
            return logClient({ error:'JSON: ' + err.message })
        }
        if (! data) throw Error('No data!') //@TODO handle better - maybe disconnect?
        logServer(data)
    }, false)

    es.addEventListener('open', evt =>
        logClient({ ok:'Connection was opened' }), false)

    es.addEventListener('error', evt => {
        evt = evt.originalTarget || evt // prefer the original error event
        if (EventSource.CONNECTING === evt.readyState)
            disconnect(config, 'of an SSE error (readyState is CONNECTING)')
        else if (EventSource.OPEN === evt.readyState)
            disconnect(config, 'of an SSE error (readyState is OPEN)')
        else if (EventSource.CLOSED === evt.readyState)
            disconnect(config, 'of an SSE error (readyState is CLOSED)')
        else if (null != evt.readyState)
            logClient({ error:'Unexpected readyState ' + evt.readyState }) // should not be possible?
        else
            logClient({ error:'No evt.readyState: ' + JSON.stringify(evt) })
    }, false)

    //// Custom events.
    es.addEventListener('disconnect', evt =>
        disconnect(config, 'server told me to'), false)
}

function disconnect (config, reason="button was clicked") {

    //// Log that `disconnect()` has been called.
    config.logClient({ ok:'disconnect() called because ' + reason })
    if (! config.es)
        return config.logClient({ error:'Can’t disconnect: EventSource is not connected' })

    //// Close the connection and make `es` falsey.
    config.es.close()
    config.es = null

    //// Update the buttons.
    config.$connect.className = ''
    config.$disconnect.className = 'hid'
}


}()</script>




<!-- Domain, used by the Admin Client and Enduser Client -->
<label>
  Domain: <input id="domain" placeholder="Loading..."></input>
  <span id="domain-comment"></span>
</label>
<script>!function(){
let
    $domain = document.querySelector('#domain')
  , $domainComment = document.querySelector('#domain-comment')
  , matchDomainRx = /^https?:\/\/[-:.a-z0-9]+/
  , validDomainRx = /^https?:\/\/[-:.a-z0-9]+\/?$/
  , localDomainRx = /^https?:\/\/(127\.0\.0\.1|localhost)/
  , pgDomain = ( location.href.match(matchDomainRx) || [])[0]
  , remoteDomain = 'https://apricot-custard-98918.herokuapp.com'
  , placeholder = localDomainRx.test(pgDomain) ? pgDomain : remoteDomain
$domain.addEventListener('input', validateDomain)
$domain.setAttribute('placeholder', placeholder)
$domain.value = $domain.value || $domain.getAttribute('placeholder')
validateDomain()
function validateDomain () {
    if (! validDomainRx.test($domain.value) )
        $domainComment.innerHTML = 'Error: invalid domain'
    else if ( localDomainRx.test($domain.value) )
        $domainComment.innerHTML = 'https' === $domain.value.slice(0,5)
          ? '(local SSL server)' : '(local servers don’t have to use https)'
    else
        $domainComment.innerHTML = 'https' === $domain.value.slice(0,5)
          ? '(remote SSL server)' : 'Error: Remote servers must use https'
    $domain.className = 'Error: ' === $domainComment.innerHTML.slice(0,7)
      ? 'invalid' : 'valid'
}
}()</script>




<!-- Admin Client -->
<hr>
<b>Admin Client:</b>
<br>
<input  id="admin-action" placeholder="notify"></input>
<input  id="admin-user"   placeholder="username"></input>
<input  id="admin-pass"   placeholder="password"></input><br>
<input  id="admin-msg"    placeholder="Message to send"></input>
<button id="admin-send">Send</button>
<button id="admin-connect">Connect</button>
<button id="admin-disconnect" class="hid">Disconnect</button>
<pre    id="admin-log">Loading...</pre>
<script>!function(){

//// Initialise the admin config and EventSource object.
const config = {
    usertype: 'admin'
  , es: null
}

//// Add references to the various admin input fields and buttons.
config.$domain = document.querySelector('#domain')
'action,msg,user,pass,send,connect,disconnect,log'.split(',')
   .forEach( name => config['$'+name] = document.querySelector('#admin-'+name) )
const { $log, $send, $connect, $disconnect } = config

//// Set up admin logging.
config.logClient = window.OOMPSH.logClient.bind($log)
config.logServer = window.OOMPSH.logServer.bind($log)
$log.lineTally = 0
$log.lines = Array(10).fill('<div>&nbsp;</div>')

//// Log a ready message.
config.logClient({ ok:'Ready to send' })

//// Set up admin buttons.
$send.addEventListener( 'click', evt => window.OOMPSH.post(config) )
$connect.addEventListener( 'click', evt => window.OOMPSH.connect(config) )
$disconnect.addEventListener( 'click', evt => window.OOMPSH.disconnect(config) )

}()</script>




<!-- Enduser Client -->
<hr>
<b>Enduser Client:</b><br>
<input  id="enduser-action" placeholder="update"></input>
<input  id="enduser-user"   placeholder="username"></input>
<input  id="enduser-pass"   placeholder="password"></input><br>
<input  id="enduser-msg"    placeholder="{ oomid:'abc', { foo:'bar' } }"></input>
<button id="enduser-send">Send</button>
<button id="enduser-connect">Connect</button>
<button id="enduser-disconnect" class="hid">Disconnect</button>
<pre    id="enduser-log">Loading...</pre>

<script>!function(){

//// Initialise the enduser config and EventSource object.
const config = {
    usertype: 'enduser'
  , es: null
}

//// Add references to the various enduser input fields and buttons.
config.$domain = document.querySelector('#domain')
'action,msg,user,pass,send,connect,disconnect,log'.split(',')
   .forEach( name => config['$'+name] = document.querySelector('#enduser-'+name) )
const { $log, $send, $connect, $disconnect } = config

//// Set up enduser logging.
config.logClient = window.OOMPSH.logClient.bind($log)
config.logServer = window.OOMPSH.logServer.bind($log)
$log.lineTally = 0
$log.lines = Array(10).fill('<div>&nbsp;</div>')

//// Log a ready message.
config.logClient({ ok:'Ready to send' })

//// Set up enduser buttons.
$send.addEventListener( 'click', evt => window.OOMPSH.post(config) )
$connect.addEventListener( 'click', evt => window.OOMPSH.connect(config) )
$disconnect.addEventListener( 'click', evt => window.OOMPSH.disconnect(config) )

}()</script>




</div><!--.container -->
</body>
</html>

<!DOCTYPE HTML>
<html lang="en-GB">
<head>




<!-- META -->

<!-- Technical meta -->
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport"
   content="width=device-width, initial-scale=1.0, shrink-to-fit=no,
            maximum-scale=1.0, user-scalable=no">

<!-- Search engine meta -->
<title>Oompsh 0.0.4</title><!-- OOMBUMPABLE -->
<meta name="description"
   content="A Node.js app broadcasting Server-Sent Events in response to a private channel">
<link rel="author" href="README.md">




<!-- SCRIPT AND STYLE -->

<style>
input, pre {
    width: 100%;
    padding: 1em;
    box-sizing: border-box;
    border-radius: 0.5em;
    border: none;
    background: #ddd;
    font: 1em/0.65 monospace;
}
input {
    width: 50%;
    background: #cde;
    border-top: 2px solid #abc;
    border-bottom: 2px solid #def;
}
</style>





</head>
<body>
<div class="container">



<!-- HEADER -->

<!-- Header and Navigation menu -->
<h1>Oompsh 0.0.4</h1><!-- OOMBUMPABLE -->
<nav>
  <a href="index.html" id="home-link">Home</a> &nbsp;
  <a href="support/test.html">Test @TODO</a> &nbsp;
  <a href="support/demo.html">Demo @TODO</a> &nbsp;
  <a href="https://github.com/loopdotcoop/oompsh">Repo</a> &nbsp;
  <a href="https://www.npmjs.com/package/oompsh">NPM</a> &nbsp;&nbsp;
</nav>

<h2>A Node.js app broadcasting Server-Sent Events in response to a private channel</h2>




<hr>
<h4>Notify Client Example:</h4>
<input  id="broadcast-url" placeholder="http://localhost:3000/notify"></input><br>
<input  id="broadcast-msg" placeholder="Message to send"></input>
<button id="broadcast-btn">Broadcast</button>
<script>!function(){
const
    $url = document.querySelector('#broadcast-url')
  , $msg = document.querySelector('#broadcast-msg')
  , $btn = document.querySelector('#broadcast-btn')
  , loc = location.href
  , notify = 'index.html' === loc.slice(-10) ? loc.slice(0,-10) : loc
$url.setAttribute('placeholder', -1 === notify.indexOf('localhost')
  ? 'https://apricot-custard-98918.herokuapp.com/notify' : notify + 'notify'
)
document.querySelector('#broadcast-btn').addEventListener('click', broadcast)
function broadcast () {
    const
        url = $url.value || $url.getAttribute('placeholder')
      , msg = $msg.value || $msg.getAttribute('placeholder')
    post(url, msg)
       .then( data => {
           console.log('ok!', data);
        })
       .catch( err => {
           console.log('oh no!', err);
        })
}

function post(url, data) {
    return new Promise( (resolve, reject) => {
        const req = new XMLHttpRequest()
        req.open('POST', url, true)
        req.onload = () => 200 === req.status
          ? resolve(req.response) : reject( Error(req.statusText) )
        req.onerror = e =>
            reject( Error(`Network Error: ${e}`) )
        req.send(data)
    })
}

}()</script>




<hr>
<h4>Events Client Example:</h4>
<input value="post,page" placeholder="types"></input>
<pre>Loading...</pre>
<script>!function(){
const
    $input = document.querySelector('input').focus()
  , $pre = document.querySelector('pre')
  , log = []

if (! window.EventSource) {
    log.push('EventSource not supprted - @TODO resort to Ajax polling')
    render()
} else {
    const events = new EventSource('events')
    events.addEventListener('message', function(e) {
        let data
        try {
            data = JSON.parse(e.data)
        } catch (err) {
            log.push('JSON error: ' + err.message)
            log.push(e.data); render()
        }
        if (data) {
            log.push(data.time + ': ' + data.payload); render()
        } else {
            events.close()
        }
    }, false)

    events.addEventListener('open', function(e) {
        log.push('Connection was opened'); render()
    }, false)

    events.addEventListener('error', function(e) {
        if (EventSource.CLOSED === e.readyState) {
            log.push('Connection was closed'); render()
        } else {
            log.push('Error: readyState ' + e.readyState); render()
        }
    }, false)
}

function render () {
    $pre.innerHTML = ''
      // + 'Tries since modification: ' + triesSinceModification + '<br><br>\n'
      // + (null == numResults ? '' : 'Try ' + getTypes() + ' at ' + tryInfo() + '<br><br><br>\n')
      + log.join('<br>\n')
}

}()</script>




</div><!--.container -->
</body>
</html>
